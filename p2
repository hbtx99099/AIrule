// 国内DNS服务器

const domesticNameservers = [

  "https://223.5.5.5/dns-query", // 阿里DoH

  "https://doh.pub/dns-query" // 腾讯DoH

];

// 国外DNS服务器

const foreignNameservers = [

  "https://208.67.222.222/dns-query", // OpenDNS

  "https://77.88.8.8/dns-query", //YandexDNS

  "https://1.1.1.1/dns-query", // CloudflareDNS

  "https://8.8.4.4/dns-query", // GoogleDNS  


];

// DNS配置

const dnsConfig = {

  "enable": true,

  "listen": "0.0.0.0:1053",

  "ipv6": false,

  "prefer-h3": false,

  "respect-rules": true,

  "use-system-hosts": false,

  "cache-algorithm": "arc",

  "enhanced-mode": "fake-ip",

  "fake-ip-range": "198.18.0.1/16",

  "fake-ip-filter": [

    // 本地主机/设备

    "+.lan",

    "+.local",

    // // Windows网络出现小地球图标

    "+.msftconnecttest.com",

    "+.msftncsi.com",

    // QQ快速登录检测失败

    "localhost.ptlogin2.qq.com",

    "localhost.sec.qq.com",

      // 追加以下条目

    "+.in-addr.arpa", 

    "+.ip6.arpa",

    "time.*.com",

    "time.*.gov",

    "pool.ntp.org",

    // 微信快速登录检测失败

    "localhost.work.weixin.qq.com"

  ],

  "default-nameserver": ["223.5.5.5","1.2.4.8"],//可修改成自己ISP的DNS

  "nameserver": [...foreignNameservers],

  "proxy-server-nameserver":[...domesticNameservers],

  "nameserver-policy": {
    // GFW列表 + 必须走代理的巨头 -> 强制远程解析，ISP 根本看不到 DNS 请求
    "geosite:gfw,google,youtube,telegram,twitter,netflix,openai": foreignNameservers,

    // 【非中国及非局域网】:
    // 任何被标记为“非中国IP”的域名 -> 强制远程解析
    "geosite:geolocation-!cn": foreignNameservers, 

  "geosite:private,cn": domesticNameservers

  }

};

// 规则集通用配置

const ruleProviderCommon = {

  "type": "http",

  "format": "yaml",

  "interval": 86400

};

// 规则集配置

const ruleProviders = {

    "AI": {

    ...ruleProviderCommon,

    "behavior": "classical",

    "url": "https://raw.githubusercontent.com/hbtx99099/AIrule/refs/heads/main/AI2.txt",

    "path": "./ruleset/loyalsoldier/AI.yaml"

  },

  "reject": {

    ...ruleProviderCommon,

    "behavior": "domain",

    "url": "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/reject.txt",

    "path": "./ruleset/loyalsoldier/reject.yaml"

  },

  "microsoft": {

    ...ruleProviderCommon,

    "behavior": "domain",

    "url": "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Microsoft/Microsoft.yaml",

    "path": "./ruleset/loyalsoldier/icloud.yaml"

  },

  "apple": {

    ...ruleProviderCommon,

    "behavior": "domain",

    "url": "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Apple/Apple_Classical.yaml",

    "path": "./ruleset/loyalsoldier/apple.yaml"

  },

  "google": {

    ...ruleProviderCommon,

    "behavior": "domain",

    "url": "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/google.txt",

    "path": "./ruleset/loyalsoldier/google.yaml"

  },

  "direct": {

    ...ruleProviderCommon,

    "behavior": "domain",

    "url": "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/direct.txt",

    "path": "./ruleset/loyalsoldier/direct.yaml"

  },

  "private": {

    ...ruleProviderCommon,

    "behavior": "domain",

    "url": "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/private.txt",

    "path": "./ruleset/loyalsoldier/private.yaml"

  },

  "gfw": {

    ...ruleProviderCommon,

    "behavior": "domain",

    "url": "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/gfw.txt",

    "path": "./ruleset/loyalsoldier/gfw.yaml"

  },

  "tld-not-cn": {

    ...ruleProviderCommon,

    "behavior": "domain",

    "url": "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/tld-not-cn.txt",

    "path": "./ruleset/loyalsoldier/tld-not-cn.yaml"

  },

  "telegramcidr": {

    ...ruleProviderCommon,

    "behavior": "ipcidr",

    "url": "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/telegramcidr.txt",

    "path": "./ruleset/loyalsoldier/telegramcidr.yaml"

  },

  "cncidr": {

    ...ruleProviderCommon,

    "behavior": "ipcidr",

    "url": "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/cncidr.txt",

    "path": "./ruleset/loyalsoldier/cncidr.yaml"

  },

  "lancidr": {

    ...ruleProviderCommon,

    "behavior": "ipcidr",

    "url": "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/lancidr.txt",

    "path": "./ruleset/loyalsoldier/lancidr.yaml"

  },

  "applications": {

    ...ruleProviderCommon,

    "behavior": "classical",

    "url": "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/applications.txt",

    "path": "./ruleset/loyalsoldier/applications.yaml"

  },

   "YouTube": {

    ...ruleProviderCommon,

    "behavior": "classical",

    "url": "https://fastly.jsdelivr.net/gh/xiaolin-007/clash@main/rule/YouTube.txt",

    "path": "./ruleset/xiaolin-007/YouTube.yaml"

  },

  "Netflix": {

    ...ruleProviderCommon,

    "behavior": "classical",

    "url": "https://fastly.jsdelivr.net/gh/xiaolin-007/clash@main/rule/Netflix.txt",

    "path": "./ruleset/xiaolin-007/Netflix.yaml"

  },

  "Spotify": {

    ...ruleProviderCommon,

    "behavior": "classical",

    "url": "https://fastly.jsdelivr.net/gh/xiaolin-007/clash@main/rule/Spotify.txt",

    "path": "./ruleset/xiaolin-007/Spotify.yaml"

  },

  "vivoblock": {

    ...ruleProviderCommon,

    "behavior": "domain",
    "format": "text",
    "url": "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/domains/native.vivo.txt",

    "path": "./ruleset/hagezi/vivoblock.yaml"

  },


  };

// 规则

const rules = [

// 【新增】阻断 QUIC (解决 Google TTS 报错核心规则，必须放在最前面)
  "AND,((NETWORK,UDP),(DST-PORT,443)),REJECT",


  // 自定义规则
"DOMAIN,dcg.microsoft.com,全局直连",
"DOMAIN,signalrs2-relayhub-prod-as01-1.service.signalr.net,全局直连",
"DOMAIN-SUFFIX,googleapis.cn,节点选择", // Google服务

  "DOMAIN-SUFFIX,gstatic.com,节点选择", // Google静态资源

  "DOMAIN-SUFFIX,xn--ngstr-lra8j.com,节点选择", // Google Play下载服务

  "DOMAIN-SUFFIX,github.io,节点选择", // Github Pages

  "DOMAIN,v2rayse.com,节点选择", // V2rayse节点工具

  // Loyalsoldier 规则集
  "RULE-SET,vivoblock,广告过滤",
  
  "RULE-SET,AI,AI规则",

  "RULE-SET,applications,全局直连",

  "RULE-SET,private,全局直连",

  "RULE-SET,reject,广告过滤",

  "RULE-SET,microsoft,微软服务",

  "RULE-SET,apple,苹果服务",

  "RULE-SET,YouTube,YouTube",

  "RULE-SET,Netflix,Netflix",  

  "RULE-SET,Spotify,Spotify",  

  "RULE-SET,google,谷歌服务",

  "RULE-SET,gfw,节点选择",

  "RULE-SET,tld-not-cn,节点选择",

  "RULE-SET,direct,全局直连",

  "RULE-SET,lancidr,全局直连,no-resolve",

  "RULE-SET,cncidr,全局直连,no-resolve",

  "RULE-SET,telegramcidr,电报消息,no-resolve",

  // 其他规则

  "GEOSITE,CN,全局直连",

  "GEOIP,LAN,全局直连,no-resolve",

  "GEOIP,CN,全局直连,no-resolve",

  "MATCH,漏网之鱼"

];

// 代理组通用配置

const groupBaseOption = {

  "interval": 300,

  "timeout": 3000,

  "url": "https://www.google.com/generate_204",

  "lazy": true,

  "max-failed-times": 3,

  "hidden": false

};


// 程序入口

function main(config) {

  const proxyCount = config?.proxies?.length ?? 0;

  const proxyProviderCount =

    typeof config?.["proxy-providers"] === "object" ? Object.keys(config["proxy-providers"]).length : 0;

  if (proxyCount === 0 && proxyProviderCount === 0) {

    throw new Error("配置文件中未找到任何代理");

  }


  // 覆盖原配置中DNS配置

  config["dns"] = dnsConfig;

const autoSelectFilter = "(?i)^(?!.*(官网|套餐|流量|异常|剩余)).*(美国|US|States|日本|JP|Japan|新加坡|SG|Singapore|台湾|TW|Taiwan).*";
const commonFilter = "^(?!.*(官网|套餐|流量|异常|剩余)).*$";
  // 覆盖原配置中的代理组

  config["proxy-groups"] = [

    {

      ...groupBaseOption,

      "name": "节点选择",

      "type": "select",

      "proxies": ["延迟选优", "故障转移","非港自动"],

      "include-all": true,

      "filter": "^(?!.*(官网|套餐|流量|异常|剩余)).*$",

      "icon": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/adjust.svg"

    },

    {

      ...groupBaseOption,

      "name": "延迟选优",

      "type": "url-test",

      "interval":120,

      "tolerance": 200,

      "include-all": true,

      "filter": "^(?!.*(官网|套餐|流量|异常|剩余)).*$",

      "icon": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/speed.svg"

    },
    {
      ...groupBaseOption,
      "name": "非港自动", // 新增的组
      "type": "url-test",    // 自动测速选择
      "interval": 120,       // 300秒测速一次 (5分钟)
      "tolerance": 100,       // 容差 50ms，节点差距小于50ms不切换，防抖动
      "include-all": true,
      "filter": autoSelectFilter, // 应用上面的地区筛选正则
      "icon": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/speed.svg"
    },
    {

      ...groupBaseOption,

      "name": "故障转移",

      "type": "fallback",

      "include-all": true,

      "filter": "^(?!.*(官网|套餐|流量|异常|剩余)).*$",

      "icon": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/ambulance.svg"

    },

    {

      ...groupBaseOption,

      "name": "AI规则",

      "type": "select",

      "proxies": ["节点选择", "延迟选优", "故障转移","非港自动"],

      "include-all": true,

      "filter": "^(?!.*(官网|套餐|流量|异常|剩余)).*$",

      "icon": "https://img.icons8.com/?size=100&id=wQWfpO826sSI&format=png&color=000000"

    },

    {

      ...groupBaseOption,

      "name": "谷歌服务",

      "type": "select",

      "proxies": ["节点选择", "延迟选优", "非港自动","全局直连"],

      "include-all": true,

      "icon": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/google.svg"

    },

    {

      ...groupBaseOption,

      "name": "YouTube",

      "type": "select",

      "proxies": ["节点选择", "延迟选优", "非港自动","全局直连"],

      "include-all": true,

      "icon": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/youtube.svg"

    },

    {

      ...groupBaseOption,

      "name": "Netflix",

      "type": "select",

      "proxies": ["节点选择", "延迟选优", "故障转移", "全局直连"],

      "include-all": true,

      "icon": "https://fastly.jsdelivr.net/gh/xiaolin-007/clash@main/icon/netflix.svg"

    },

    {

      ...groupBaseOption,

      "name": "电报消息",

      "type": "select",

      "proxies": ["节点选择", "延迟选优", "故障转移", "全局直连"],

      "include-all": true,

      "icon": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/telegram.svg"

    },

        {

      ...groupBaseOption,

      "name": "微软服务",

      "type": "select",

      "proxies": ["全局直连", "节点选择", "延迟选优"],

      "include-all": true,

      "icon": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/microsoft.svg"

    },

    {

      ...groupBaseOption,

      "name": "苹果服务",

      "type": "select",

      "proxies": ["节点选择", "延迟选优", "故障转移","全局直连"],

      "include-all": true,

      "icon": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/apple.svg"

    },    

    {

      ...groupBaseOption,

      "name": "Spotify",

      "type": "select",

      "proxies": ["节点选择", "延迟选优", "故障转移","全局直连"],

      "include-all": true,

      "icon": "https://fastly.jsdelivr.net/gh/xiaolin-007/clash@main/icon/spotify.svg"

    },

    {

      ...groupBaseOption,

      "name": "广告过滤",

      "type": "select",

      "proxies": ["REJECT", "DIRECT"],

      "icon": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/bug.svg"

    },

    {

      ...groupBaseOption,

      "name": "全局直连",

      "type": "select",

      "proxies": ["DIRECT", "节点选择", "延迟选优", "故障转移"],

      "include-all": true,

      "icon": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/link.svg"

    },

    {

      ...groupBaseOption,

      "name": "全局拦截",

      "type": "select",

      "proxies": ["REJECT", "DIRECT"],

      "icon": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/block.svg"

    },

    

    {

      ...groupBaseOption,

      "name": "漏网之鱼",

      "type": "select",

      "proxies": ["节点选择", "延迟选优", "故障转移","全局直连"],

      "include-all": true,

      "filter": "^(?!.*(官网|套餐|流量|异常|剩余)).*$",

      "icon": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/fish.svg"

    }

  ];


  // 覆盖原配置中的规则

  config["rule-providers"] = ruleProviders;

  config["rules"] = rules;

  config["proxies"].forEach(proxy => {

    // 为每个节点设置 udp = true

    proxy.udp = true


  })

  // 强制开启域名嗅探，解决 DNS 污染
  config["sniffer"] = {
    "enable": true,
    "parse-pure-ip": true,
    "override-destination": true,
    "sniff": {
      "TLS": {
        "ports": [443, 8443]
      },
      "HTTP": {
        "ports": [80, 8080],
        "override-destination": true
      }
    }
  };


  // 返回修改后的配置

  return config;

}
